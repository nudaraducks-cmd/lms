<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Sub-tab styling */
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        
        .nav-link.active {
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }

        .sub-nav-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-graduation-cap text-blue-600 text-2xl"></i>
                    <h1 class="text-xl font-bold text-gray-900">LMS Admin Panel</h1>
                </div>
                <div class="flex items-center">
                    <div id="user-status" class="text-sm text-gray-500 mr-4 hidden md:block">Connecting...</div>
                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fa-solid fa-user-shield"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col">
            <div class="p-6">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Main Menu</p>
                <nav class="space-y-2" id="sidebar-nav">
                    <button onclick="switchTab('home')" class="nav-link w-full flex items-center gap-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                        <i class="fa-solid fa-house w-5"></i> Home
                    </button>
                    <button onclick="switchTab('study-packs')" id="nav-study-packs" class="nav-link w-full flex items-center gap-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors active">
                        <i class="fa-solid fa-box-archive w-5"></i> Study Packs
                    </button>
                    <button onclick="switchTab('online-classes')" class="nav-link w-full flex items-center gap-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                        <i class="fa-solid fa-video w-5"></i> Online Classes
                    </button>
                    <button onclick="switchTab('students')" class="nav-link w-full flex items-center gap-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                        <i class="fa-solid fa-users w-5"></i> Students
                    </button>
                    <button onclick="switchTab('settings')" class="nav-link w-full flex items-center gap-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                        <i class="fa-solid fa-gear w-5"></i> Settings
                    </button>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            
            <div class="max-w-5xl mx-auto space-y-8">
                
                <!-- Home Tab -->
                <div id="home" class="tab-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-900">Welcome to Dashboard</h2>
                    <div class="bg-blue-600 p-8 rounded-2xl text-white shadow-lg relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="text-2xl font-bold">Hello Admin!</h3>
                            <p class="opacity-90 mt-2">Manage your students and learning materials from here efficiently.</p>
                        </div>
                        <i class="fa-solid fa-rocket absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i>
                    </div>
                </div>

                <!-- Study Packs Tab -->
                <div id="study-packs" class="tab-content active space-y-8">
                    <div id="packs-list-view" class="space-y-8">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Manage Study Packs</h2>
                                <p class="text-gray-500 text-sm mt-1">Add, edit, or remove learning materials.</p>
                            </div>
                            <button onclick="toggleModal('add-course-modal')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium transition-all flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> Add New Study Pack
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 font-medium">Total Study Packs</p>
                                    <h3 class="text-3xl font-bold text-gray-900 mt-1" id="total-courses-count">0</h3>
                                </div>
                                <div class="h-12 w-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-xl">
                                    <i class="fa-solid fa-box-open"></i>
                                </div>
                            </div>
                        </div>

                        <div id="course-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
                                <div class="loader mb-4"></div>
                                <p>Loading study packs from database...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Lessons Management View -->
                    <div id="lessons-management-view" class="hidden space-y-6">
                        <div class="flex items-center gap-4 mb-2">
                            <button onclick="backToPacks()" class="text-gray-400 hover:text-blue-600 transition-colors">
                                <i class="fa-solid fa-arrow-left text-xl"></i>
                            </button>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900" id="current-pack-title">Loading...</h2>
                                <p class="text-sm text-gray-500">Add and manage lessons for this pack</p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold mb-4 text-gray-700">Upload New Lesson</h3>
                            <form id="add-lesson-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Lesson Name</label>
                                    <input type="text" id="lesson-name" required placeholder="e.g. Intro" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Resource URL</label>
                                    <input type="url" id="lesson-url" required placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                </div>
                                <div class="flex items-end">
                                    <button type="submit" id="lesson-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 text-sm">
                                        <i class="fa-solid fa-cloud-arrow-up"></i> Add Lesson
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Lesson Name</th>
                                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">URL</th>
                                        <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="lessons-list" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Online Classes Tab -->
                <div id="online-classes" class="tab-content space-y-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-gray-200 pb-2">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Online Classes</h2>
                        </div>
                        <div class="flex gap-6">
                            <button onclick="switchSubTab('live')" id="sub-nav-live" class="sub-nav-btn active py-2 font-semibold text-sm transition-all">Live Class</button>
                            <button onclick="switchSubTab('recordings')" id="sub-nav-recordings" class="sub-nav-btn py-2 font-semibold text-sm text-gray-400 transition-all">Recordings</button>
                        </div>
                    </div>

                    <!-- Sub Tab: Live -->
                    <div id="sub-tab-live" class="sub-tab-content active animate-in fade-in duration-300">
                        <div class="max-w-xl mx-auto py-10">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-red-50 relative overflow-hidden">
                                <div class="flex items-center gap-3 mb-8">
                                    <div class="h-12 w-12 bg-red-100 text-red-600 rounded-xl flex items-center justify-center">
                                        <i class="fa-solid fa-satellite-dish text-xl animate-pulse"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold">Live Stream & Schedule</h3>
                                        <p class="text-xs text-gray-500">Schedule or update live meeting links</p>
                                    </div>
                                </div>
                                <form id="live-class-form" class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-tight">Class Title / Subject</label>
                                        <input type="text" id="live-title" placeholder="e.g. Science - Unit 05 Live" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-tight">Scheduled Date</label>
                                            <input type="date" id="live-date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-tight">Time</label>
                                            <input type="time" id="live-time" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-tight">Zoom / Google Meet URL</label>
                                        <input type="url" id="live-url" required placeholder="https://zoom.us/j/..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-tight">Current Status Message</label>
                                        <input type="text" id="live-status" placeholder="e.g. Meeting will start soon..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-gray-50 focus:bg-white">
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 pt-4">
                                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold text-sm transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-calendar-check"></i> Save Schedule
                                        </button>
                                        <a id="start-zoom-btn" href="#" target="_blank" class="w-full bg-gray-900 hover:bg-black text-white py-3 rounded-xl font-bold text-sm transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 opacity-50 cursor-not-allowed">
                                            <i class="fa-solid fa-video"></i> Start Meeting
                                        </a>
                                    </div>
                                </form>
                                <i class="fa-solid fa-video absolute -right-4 -bottom-4 text-8xl text-red-500 opacity-5"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Sub Tab: Recordings -->
                    <div id="sub-tab-recordings" class="sub-tab-content animate-in fade-in duration-300 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="md:col-span-1">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="h-10 w-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center">
                                            <i class="fa-solid fa-plus"></i>
                                        </div>
                                        <h3 class="font-bold">Add Recording</h3>
                                    </div>
                                    <form id="add-recording-form" class="space-y-4">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">Video Title</label>
                                            <input type="text" id="recording-title" required placeholder="Unit 05 Discussion" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-400 uppercase mb-1">YouTube URL</label>
                                            <input type="url" id="recording-url" required placeholder="https://..." class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                        </div>
                                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold text-sm transition-all">
                                            Save Link
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="md:col-span-2">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                                        <h3 class="font-bold text-gray-700">Recent Class Recordings</h3>
                                    </div>
                                    <div id="recordings-list" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
                                         <!-- Dynamically Filled -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Tab -->
                <div id="students" class="tab-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-900">Student Management</h2>
                    <div class="bg-white p-12 border border-gray-200 rounded-xl text-center">
                        <p class="text-gray-500">Student database module will be available in the next update.</p>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings" class="tab-content space-y-8">
                    <h2 class="text-2xl font-bold text-gray-900">Admin Settings</h2>
                    <div class="bg-white p-6 border border-gray-200 rounded-xl">
                        <p class="text-gray-500">Configure your LMS preferences here.</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-course-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-900">Create New Study Pack</h3>
                <button onclick="toggleModal('add-course-modal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form id="add-course-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Study Pack Title</label>
                    <input type="text" id="course-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="course-desc" required rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail Image URL (Optional)</label>
                    <input type="url" id="course-img" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://example.com/image.jpg">
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="toggleModal('add-course-modal')" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">Cancel</button>
                    <button type="submit" id="submit-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-sm flex items-center gap-2">
                        <span>Create Pack</span>
                        <div id="btn-loader" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-white border-l-4 border-green-500 text-gray-800 px-6 py-4 rounded shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-green-500 text-xl" id="toast-icon"></i>
        <span id="toast-message" class="text-sm font-medium">Success!</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, query, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activePackId = null;
        let lessonsUnsubscribe = null;

        // --- TAB SWITCHING ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            const activeBtn = Array.from(document.querySelectorAll('.nav-link')).find(b => b.getAttribute('onclick').includes(tabId));
            if(activeBtn) activeBtn.classList.add('active');

            if(tabId === 'study-packs') backToPacks();
            if(tabId === 'online-classes') loadOnlineClassData();
        };

        // --- SUB-TAB SWITCHING (Online Classes) ---
        window.switchSubTab = (subId) => {
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.sub-nav-btn').forEach(b => {
                b.classList.remove('active', 'text-gray-900');
                b.classList.add('text-gray-400');
            });

            document.getElementById(`sub-tab-${subId}`).classList.add('active');
            const activeBtn = document.getElementById(`sub-nav-${subId}`);
            activeBtn.classList.add('active', 'text-gray-900');
            activeBtn.classList.remove('text-gray-400');
        };

        // --- AUTH ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { console.error("Auth error", err); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-status').textContent = `Admin ID: ${user.uid.slice(0, 6)}`;
                loadCourses();
                loadOnlineClassData(); 
            }
        });

        // --- STUDY PACKS LOGIC ---
        const loadCourses = () => {
            const courseGrid = document.getElementById('course-grid');
            const totalCount = document.getElementById('total-courses-count');
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'courses'));

            onSnapshot(q, (snapshot) => {
                const courses = [];
                snapshot.forEach(doc => courses.push({ id: doc.id, ...doc.data() }));
                courses.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                totalCount.textContent = courses.length;

                if (courses.length === 0) {
                    courseGrid.innerHTML = `<div class="col-span-full py-16 text-center border-2 border-dashed rounded-xl bg-gray-50">No packs found.</div>`;
                    return;
                }

                courseGrid.innerHTML = courses.map(course => `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group hover:shadow-md transition-all cursor-pointer" onclick="openPackDetails('${course.id}', '${course.title.replace(/'/g, "\\'")}')">
                        <div class="relative h-44 overflow-hidden bg-gray-100">
                            <img src="${course.image || 'https://placehold.co/600x400/eff6ff/3b82f6?text=Study+Pack'}" class="w-full h-full object-cover group-hover:scale-110 transition-all duration-500">
                            <button onclick="event.stopPropagation(); deleteCourse('${course.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 bg-white text-red-500 p-2 rounded shadow hover:bg-red-50"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-gray-900 truncate">${course.title}</h3>
                            <p class="text-gray-500 text-xs mt-1 line-clamp-2 h-8">${course.description}</p>
                            <div class="mt-4 pt-4 border-t flex justify-between items-center text-blue-600 text-xs font-bold">
                                <span>ID: ${course.id.slice(0, 6)}</span>
                                <span>Lessons &rarr;</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        };

        window.openPackDetails = (id, title) => {
            activePackId = id;
            document.getElementById('current-pack-title').textContent = title;
            document.getElementById('packs-list-view').classList.add('hidden');
            document.getElementById('lessons-management-view').classList.remove('hidden');
            loadLessons(id);
        };

        window.backToPacks = () => {
            if(lessonsUnsubscribe) lessonsUnsubscribe();
            document.getElementById('packs-list-view').classList.remove('hidden');
            document.getElementById('lessons-management-view').classList.add('hidden');
        };

        const loadLessons = (id) => {
            const list = document.getElementById('lessons-list');
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'courses', id, 'lessons'));
            lessonsUnsubscribe = onSnapshot(q, (snapshot) => {
                const lessons = [];
                snapshot.forEach(doc => lessons.push({ id: doc.id, ...doc.data() }));
                if (lessons.length === 0) {
                    list.innerHTML = `<tr><td colspan="3" class="px-6 py-10 text-center text-gray-400">No lessons.</td></tr>`;
                    return;
                }
                list.innerHTML = lessons.map(l => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 text-sm font-semibold">${l.name}</td>
                        <td class="px-6 py-4 text-xs text-blue-500 truncate max-w-xs"><a href="${l.url}" target="_blank">${l.url}</a></td>
                        <td class="px-6 py-4 text-right"><button onclick="deleteLesson('${l.id}')" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button></td>
                    </tr>
                `).join('');
            });
        };

        document.getElementById('add-lesson-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!activePackId) return;
            const name = document.getElementById('lesson-name').value;
            const url = document.getElementById('lesson-url').value;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses', activePackId, 'lessons'), { name, url, createdAt: serverTimestamp() });
                e.target.reset();
                showToast("Lesson added!");
            } catch (err) { showToast("Error", "error"); }
        });

        // --- ONLINE CLASS LOGIC ---
        const loadOnlineClassData = () => {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'online_config', 'live'), (snapshot) => {
                const zoomBtn = document.getElementById('start-zoom-btn');
                if(snapshot.exists()){
                    const data = snapshot.data();
                    document.getElementById('live-title').value = data.title || "";
                    document.getElementById('live-date').value = data.date || "";
                    document.getElementById('live-time').value = data.time || "";
                    document.getElementById('live-url').value = data.url || "";
                    document.getElementById('live-status').value = data.status || "";
                    
                    if(data.url) {
                        zoomBtn.href = data.url;
                        zoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        zoomBtn.href = "#";
                        zoomBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            });

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'online_recordings'));
            onSnapshot(q, (snapshot) => {
                const recordings = [];
                snapshot.forEach(doc => recordings.push({ id: doc.id, ...doc.data() }));
                recordings.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                const list = document.getElementById('recordings-list');
                if(recordings.length === 0) {
                    list.innerHTML = `<div class="p-10 text-center text-gray-400">No recordings added yet.</div>`;
                    return;
                }
                list.innerHTML = recordings.map(r => `
                    <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition-colors group">
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fa-brands fa-youtube"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-800">${r.title}</h4>
                                <p class="text-[10px] text-gray-400">${r.createdAt ? new Date(r.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <a href="${r.url}" target="_blank" class="px-3 py-1 bg-white border border-gray-200 text-gray-600 rounded text-xs hover:bg-gray-50 transition-colors">View</a>
                            <button onclick="deleteRecording('${r.id}')" class="text-gray-300 hover:text-red-500 p-2 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                `).join('');
            });
        };

        document.getElementById('live-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('live-title').value;
            const date = document.getElementById('live-date').value;
            const time = document.getElementById('live-time').value;
            const url = document.getElementById('live-url').value;
            const status = document.getElementById('live-status').value;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'online_config', 'live'), {
                    title, date, time, url, status, updatedAt: serverTimestamp()
                });
                showToast("Schedule updated successfully!");
            } catch (err) { showToast("Update failed", "error"); }
        });

        document.getElementById('add-recording-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('recording-title').value;
            const url = document.getElementById('recording-url').value;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'online_recordings'), {
                    title, url, createdAt: serverTimestamp()
                });
                e.target.reset();
                showToast("Recording saved!");
            } catch (err) { showToast("Save failed", "error"); }
        });

        window.deleteRecording = async (id) => {
            if(confirm("Remove this recording?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'online_recordings', id));
                showToast("Deleted");
            }
        };

        // --- COMMON UTILS ---
        document.getElementById('add-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), {
                    title: document.getElementById('course-title').value,
                    description: document.getElementById('course-desc').value,
                    image: document.getElementById('course-img').value || "",
                    createdAt: serverTimestamp(),
                    createdBy: currentUser?.uid
                });
                toggleModal('add-course-modal');
                e.target.reset();
                showToast("Pack created!");
            } catch (err) { showToast("Failed", "error"); }
            finally { btn.disabled = false; }
        });

        window.deleteCourse = async (id) => {
            if(confirm("Delete this study pack? This will not delete the lessons inside.")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', id));
                showToast("Deleted pack");
            }
        };

        window.deleteLesson = async (lid) => {
            if(confirm("Delete this lesson?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', activePackId, 'lessons', lid));
                showToast("Deleted lesson");
            }
        };

        window.toggleModal = (id) => {
            const m = document.getElementById(id);
            if(m.classList.contains('hidden')){
                m.classList.remove('hidden');
                setTimeout(() => m.classList.remove('opacity-0'), 10);
            } else {
                m.classList.add('opacity-0');
                setTimeout(() => m.classList.add('hidden'), 3000);
            }
        };

        window.showToast = (msg, type="success") => {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        };
    </script>
</body>
</html>
